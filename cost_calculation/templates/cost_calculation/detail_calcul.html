{% extends "cost_calculation/base.html" %}
{% load static %}

{% block page_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-calculator"></i> Détail du Calcul #{{ calcul.id }}</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'cost_calculation:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'cost_calculation:liste_calculs' %}">Calculs</a></li>
                <li class="breadcrumb-item active">Calcul #{{ calcul.id }}</li>
            </ol>
        </nav>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-success" onclick="exportCalcul()">
            <i class="fas fa-download"></i> Exporter
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="duplicateCalcul()">
            <i class="fas fa-copy"></i> Dupliquer
        </button>
        <button type="button" class="btn btn-outline-warning" onclick="recalculateCalcul()">
            <i class="fas fa-sync"></i> Recalculer
        </button>
    </div>
</div>

<!-- Informations générales -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Informations Générales</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Référence:</strong></td>
                                <td>
                                    {% if calcul.commande %}
                                        <i class="fas fa-shopping-cart text-primary"></i> Commande {{ calcul.commande.id }}
                                        {% if calcul.commande.client %}
                                            <br><small class="text-muted">Client: {{ calcul.commande.client.nom }}</small>
                                        {% endif %}
                                    {% elif calcul.ordre_production %}
                                        <i class="fas fa-industry text-success"></i> {{ calcul.ordre_production.numero_bon }}
                                        <br><small class="text-muted">Production</small>
                                    {% else %}
                                        <i class="fas fa-calculator text-info"></i> Simulation
                                        {% if calcul.description %}
                                            <br><small class="text-muted">{{ calcul.description }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Formule:</strong></td>
                                <td>
                                    <strong>{{ calcul.formule.nom }}</strong>
                                    {% if calcul.formule.description %}
                                        <br><small class="text-muted">{{ calcul.formule.description }}</small>
                                    {% endif %}
                                    {% if calcul.formule.resistance_requise %}
                                        <br><span class="badge bg-info">{{ calcul.formule.resistance_requise }} MPa</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Quantité:</strong></td>
                                <td><strong>{{ calcul.quantite_calculee|floatformat:2 }} {{ calcul.unite_mesure }}</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Date de calcul:</strong></td>
                                <td>{{ calcul.date_calcul|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Calculé par:</strong></td>
                                <td>{{ calcul.calculé_par|default:"Système automatique" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Marge bénéficiaire:</strong></td>
                                <td>
                                    {% if calcul.marge_beneficiaire %}
                                        <span class="badge bg-success fs-6">{{ calcul.marge_beneficiaire|floatformat:2 }}%</span>
                                    {% else %}
                                        <span class="text-muted">Non définie</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-euro-sign"></i> Résumé des Coûts</h5>
            </div>
            <div class="card-body">
                <div class="cost-summary">
                    <div class="cost-item">
                        <span><i class="fas fa-boxes text-primary"></i> Matières Premières</span>
                        <span class="cost-value">{{ calcul.coût_matieres|default:0|floatformat:2 }}€</span>
                    </div>
                    <div class="cost-item">
                        <span><i class="fas fa-users text-success"></i> Main d'Œuvre</span>
                        <span class="cost-value">{{ calcul.coût_main_oeuvre|default:0|floatformat:2 }}€</span>
                    </div>
                    <div class="cost-item">
                        <span><i class="fas fa-cogs text-warning"></i> Frais Généraux</span>
                        <span class="cost-value">{{ calcul.coût_frais_generaux|default:0|floatformat:2 }}€</span>
                    </div>
                    <div class="cost-item">
                        <span><i class="fas fa-truck text-info"></i> Transport</span>
                        <span class="cost-value">{{ calcul.coût_transport|default:0|floatformat:2 }}€</span>
                    </div>
                    <hr>
                    <div class="cost-item total">
                        <span><strong>Total</strong></span>
                        <span class="cost-value"><strong>{{ calcul.coût_total|floatformat:2 }}€</strong></span>
                    </div>
                    <div class="cost-item unit">
                        <span>Coût unitaire</span>
                        <span class="cost-value">{{ calcul.coût_unitaire_total|floatformat:2 }}€/m³</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Détail des matières premières -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-boxes"></i> Détail des Matières Premières</h5>
            </div>
            <div class="card-body">
                {% if calcul.details_matieres.all %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Matière Première</th>
                                    <th>Quantité Nécessaire</th>
                                    <th>Prix Unitaire</th>
                                    <th>Coût Transport</th>
                                    <th>Coût Stockage</th>
                                    <th>Coût Total</th>
                                    <th>% du Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detail in calcul.details_matieres.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="material-icon me-2">
                                                {% if detail.matiere_premiere.type_matiere == 'ciment' %}
                                                    <i class="fas fa-cube text-secondary"></i>
                                                {% elif detail.matiere_premiere.type_matiere == 'granulat' %}
                                                    <i class="fas fa-mountain text-warning"></i>
                                                {% elif detail.matiere_premiere.type_matiere == 'sable' %}
                                                    <i class="fas fa-layer-group text-info"></i>
                                                {% elif detail.matiere_premiere.type_matiere == 'eau' %}
                                                    <i class="fas fa-tint text-primary"></i>
                                                {% else %}
                                                    <i class="fas fa-box text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ detail.matiere_premiere.nom }}</strong>
                                                <br><small class="text-muted">{{ detail.matiere_premiere.unite_mesure }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ detail.quantite_necessaire|floatformat:2 }}</strong>
                                        {{ detail.matiere_premiere.unite_mesure }}
                                    </td>
                                    <td>{{ detail.prix_unitaire|floatformat:2 }}€</td>
                                    <td>{{ detail.coût_transport|default:0|floatformat:2 }}€</td>
                                    <td>{{ detail.coût_stockage|default:0|floatformat:2 }}€</td>
                                    <td>
                                        <strong class="text-success">{{ detail.coût_total|floatformat:2 }}€</strong>
                                    </td>
                                    <td>
                                        {% if calcul.coût_matieres %}
                                            <span class="badge bg-secondary">
                                                {{ detail.coût_total|mul:100|div:calcul.coût_matieres|floatformat:1 }}%
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="5">Total Matières Premières</th>
                                    <th>{{ calcul.coût_matieres|floatformat:2 }}€</th>
                                    <th>100%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-boxes fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Aucun détail de matières premières disponible</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Graphiques de répartition -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Répartition des Coûts</h5>
            </div>
            <div class="card-body">
                <canvas id="costBreakdownChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Répartition des Matières</h5>
            </div>
            <div class="card-body">
                <canvas id="materialsChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Historique et notes -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Historique des Modifications</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6>Calcul créé</h6>
                            <p class="text-muted mb-1">{{ calcul.date_calcul|date:"d/m/Y H:i" }}</p>
                            <small class="text-muted">Par {{ calcul.calculé_par|default:"Système" }}</small>
                        </div>
                    </div>
                    {% if calcul.date_modification %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6>Dernière modification</h6>
                            <p class="text-muted mb-1">{{ calcul.date_modification|date:"d/m/Y H:i" }}</p>
                            <small class="text-muted">Recalcul automatique</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sticky-note"></i> Notes et Commentaires</h5>
            </div>
            <div class="card-body">
                <form id="notesForm">
                    <div class="mb-3">
                        <textarea class="form-control" rows="4" placeholder="Ajouter une note ou un commentaire...">{{ calcul.notes|default:"" }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                </form>
                
                {% if calcul.description %}
                <div class="mt-3">
                    <h6>Description:</h6>
                    <p class="text-muted">{{ calcul.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique de répartition des coûts
    const ctx1 = document.getElementById('costBreakdownChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['Matières Premières', 'Main d\'Œuvre', 'Frais Généraux', 'Transport'],
            datasets: [{
                data: [
                    {{ calcul.coût_matieres|default:0 }},
                    {{ calcul.coût_main_oeuvre|default:0 }},
                    {{ calcul.coût_frais_generaux|default:0 }},
                    {{ calcul.coût_transport|default:0 }}
                ],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#17a2b8'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = {{ calcul.coût_total }};
                            const percentage = ((value / total) * 100).toFixed(1);
                            return context.label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Graphique des matières premières
    const ctx2 = document.getElementById('materialsChart').getContext('2d');
    const materialsData = [
        {% for detail in calcul.details_matieres.all %}
        {
            label: '{{ detail.matiere_premiere.nom|escapejs }}',
            value: {{ detail.coût_total }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    if (materialsData.length > 0) {
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: materialsData.map(item => item.label),
                datasets: [{
                    label: 'Coût (€)',
                    data: materialsData.map(item => item.value),
                    backgroundColor: [
                        '#007bff', '#28a745', '#ffc107', '#17a2b8', 
                        '#dc3545', '#6f42c1', '#fd7e14', '#20c997'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });
    } else {
        ctx2.canvas.parentElement.innerHTML = '<div class="text-center py-4"><i class="fas fa-chart-bar fa-2x text-muted mb-3"></i><p class="text-muted">Aucune donnée de matières disponible</p></div>';
    }

    // Gestion du formulaire de notes
    document.getElementById('notesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const notes = this.querySelector('textarea').value;
        
        fetch(`/cost-calculation/api/calculs/{{ calcul.id }}/`, {
            method: 'PATCH',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes: notes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                showAlert('Notes sauvegardées avec succès', 'success');
            } else {
                showAlert('Erreur lors de la sauvegarde', 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur lors de la sauvegarde', 'danger');
        });
    });
});

function exportCalcul() {
    window.open(`/cost-calculation/export/?ids={{ calcul.id }}&format=pdf`, '_blank');
}

function duplicateCalcul() {
    if (confirm('Voulez-vous dupliquer ce calcul ?')) {
        fetch(`/cost-calculation/api/calculs/{{ calcul.id }}/duplicate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Calcul dupliqué avec succès', 'success');
                setTimeout(() => {
                    window.location.href = `/cost-calculation/calculs/${data.new_id}/`;
                }, 1000);
            } else {
                showAlert('Erreur lors de la duplication', 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur lors de la duplication', 'danger');
        });
    }
}

function recalculateCalcul() {
    if (confirm('Voulez-vous recalculer ce calcul avec les prix actuels ?')) {
        fetch(`/cost-calculation/api/calculs/{{ calcul.id }}/recalculate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Calcul recalculé avec succès', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Erreur lors du recalcul', 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur lors du recalcul', 'danger');
        });
    }
}
</script>

<style>
.cost-summary .cost-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
}

.cost-summary .cost-item.total {
    border-top: 2px solid #dee2e6;
    border-bottom: none;
    font-size: 1.1em;
    margin-top: 0.5rem;
    padding-top: 1rem;
}

.cost-summary .cost-item.unit {
    border-bottom: none;
    color: #6c757d;
    font-size: 0.9em;
}

.cost-value {
    font-weight: 600;
    color: #28a745;
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-marker {
    position: absolute;
    left: -2rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 3px solid #007bff;
}

.material-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 50%;
}
</style>
{% endblock %}