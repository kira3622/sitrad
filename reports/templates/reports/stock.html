{% extends 'admin/base_site.html' %}
{% load static %}

{% block title %}{{ title }} - {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .report-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .report-header {
        background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .report-header h1 {
        margin: 0;
        font-size: 2.2em;
        font-weight: 300;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 5px solid #9C27B0;
    }
    
    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #9C27B0;
        margin-bottom: 10px;
    }
    
    .stat-label {
        color: #666;
        font-size: 1.1em;
    }
    
    .section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .section h3 {
        margin: 0 0 20px 0;
        color: #333;
        border-bottom: 2px solid #9C27B0;
        padding-bottom: 10px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .table th,
    .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
    }
    
    .table tr:hover {
        background-color: #f5f5f5;
    }
    
    .alert-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .alert-critique {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .alert-bas {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .alert-normal {
        background-color: #d4edda;
        color: #155724;
    }
    
    .mouvement-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .mouvement-entree {
        background-color: #d4edda;
        color: #155724;
    }
    
    .mouvement-sortie {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .no-data {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 40px;
    }
    
    .export-actions {
        text-align: right;
        margin-bottom: 20px;
    }
    
    .btn-export {
        padding: 10px 20px;
        background-color: #007cba;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: 500;
        margin-left: 10px;
    }
    
    .btn-export:hover {
        background-color: #005a87;
        color: white;
    }
    
    .alertes-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .alertes-section h3 {
        color: #856404;
        margin: 0 0 15px 0;
        border-bottom: 2px solid #ffeaa7;
        padding-bottom: 10px;
    }
    
    .alerte-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #dc3545;
    }
    
    .alerte-item.critique {
        border-left-color: #dc3545;
    }
    
    .alerte-item.bas {
        border-left-color: #ffc107;
    }
    
    .stock-level {
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .stock-critique {
        color: #dc3545;
    }
    
    .stock-bas {
        color: #ffc107;
    }
    
    .stock-normal {
        color: #28a745;
    }
    
    .chart-container {
        height: 300px;
        margin: 20px 0;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h1>üì¶ Rapport de Stock</h1>
        <p>√âtat des stocks et mouvements des 30 derniers jours</p>
    </div>
    
    <div class="export-actions">
        <a href="{% url 'reports:dashboard' %}" class="btn-export" style="background-color: #6c757d;">‚Üê Retour au tableau de bord</a>
        <a href="{% url 'reports:export_pdf' 'stock' %}" class="btn-export">üìÑ Export PDF</a>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stocks_actuels|length }}</div>
            <div class="stat-label">Mati√®res premi√®res</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats_mouvements.total_entrees|floatformat:1 }}</div>
            <div class="stat-label">Total entr√©es (30j)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats_mouvements.total_sorties|floatformat:1 }}</div>
            <div class="stat-label">Total sorties (30j)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ alertes|length }}</div>
            <div class="stat-label">Alertes de stock</div>
        </div>
    </div>
    
    {% if alertes %}
    <div class="alertes-section">
        <h3>‚ö†Ô∏è Alertes de Stock</h3>
        {% for alerte in alertes %}
        <div class="alerte-item {{ alerte.niveau_alerte }}">
            <strong>{{ alerte.matiere.nom }}</strong> - 
            <span class="stock-level stock-{{ alerte.niveau_alerte }}">
                {{ alerte.stock_actuel|floatformat:1 }} {{ alerte.matiere.unite_mesure }}
            </span>
            {% if alerte.niveau_alerte == 'critique' %}
                <span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è STOCK CRITIQUE (‚â§ {{ seuil_critique }})</span>
            {% elif alerte.niveau_alerte == 'bas' %}
                <span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è STOCK BAS (‚â§ {{ seuil_bas }})</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="section">
        <h3>üìä √âtat Actuel des Stocks</h3>
        {% if stocks_actuels %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Mati√®re premi√®re</th>
                        <th>Stock actuel</th>
                        <th>Unit√©</th>
                        <th>Niveau d'alerte</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks_actuels %}
                    <tr>
                        <td>{{ stock.matiere.nom }}</td>
                        <td class="stock-level stock-{{ stock.niveau_alerte }}">
                            {{ stock.stock_actuel|floatformat:1 }}
                        </td>
                        <td>{{ stock.matiere.unite_mesure }}</td>
                        <td>
                            <span class="alert-badge alert-{{ stock.niveau_alerte }}">
                                {% if stock.niveau_alerte == 'critique' %}üî¥ Critique
                                {% elif stock.niveau_alerte == 'bas' %}üü° Bas
                                {% else %}üü¢ Normal{% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">Aucune mati√®re premi√®re trouv√©e.</div>
        {% endif %}
    </div>
    
    <div class="section">
        <h3>üìã Mouvements R√©cents (20 derniers)</h3>
        {% if mouvements_recents %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Mati√®re premi√®re</th>
                        <th>Type</th>
                        <th>Quantit√©</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mouvement in mouvements_recents %}
                    <tr>
                        <td>{{ mouvement.date_mouvement|date:"d/m/Y H:i" }}</td>
                        <td>{{ mouvement.matiere_premiere.nom }}</td>
                        <td>
                            <span class="mouvement-badge mouvement-{{ mouvement.type_mouvement }}">
                                {% if mouvement.type_mouvement == 'entree' %}‚¨ÜÔ∏è Entr√©e
                                {% else %}‚¨áÔ∏è Sortie{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if mouvement.type_mouvement == 'entree' %}+{% else %}-{% endif %}{{ mouvement.quantite|floatformat:1 }} {{ mouvement.matiere_premiere.unite_mesure }}
                        </td>
                        <td>{{ mouvement.description|default:"N/A" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">Aucun mouvement de stock r√©cent.</div>
        {% endif %}
    </div>
    
    <div class="section">
        <h3>üìà Mouvements par Mati√®re Premi√®re</h3>
        {% if mouvements_par_matiere %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Mati√®re premi√®re</th>
                        <th>Entr√©es (30j)</th>
                        <th>Sorties (30j)</th>
                        <th>Solde</th>
                        <th>Nombre de mouvements</th>
                    </tr>
                </thead>
                <tbody>
                    {% for matiere in mouvements_par_matiere %}
                    <tr>
                        <td>{{ matiere.matiere_premiere__nom }}</td>
                        <td style="color: #28a745; font-weight: 500;">
                            +{{ matiere.entrees|default:0|floatformat:1 }}
                        </td>
                        <td style="color: #dc3545; font-weight: 500;">
                            -{{ matiere.sorties|default:0|floatformat:1 }}
                        </td>
                        <td style="font-weight: bold;">
                            {% with entrees=matiere.entrees|default:0 sorties=matiere.sorties|default:0 %}
                                {% if entrees > sorties %}
                                    <span style="color: #28a745;">+{{ entrees|floatformat:1 }}</span>
                                {% elif sorties > entrees %}
                                    <span style="color: #dc3545;">-{{ sorties|floatformat:1 }}</span>
                                {% else %}
                                    <span style="color: #666;">0.0</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>{{ matiere.nombre_mouvements }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">Aucune donn√©e de mouvement par mati√®re premi√®re.</div>
        {% endif %}
    </div>
    
    <div class="section">
        <h3>üìÖ √âvolution Quotidienne des Stocks</h3>
        {% if evolution_stock %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type de mouvement</th>
                        <th>Quantit√© totale</th>
                    </tr>
                </thead>
                <tbody>
                    {% for evolution in evolution_stock %}
                    <tr>
                        <td>{{ evolution.jour|date:"d/m/Y" }}</td>
                        <td>
                            <span class="mouvement-badge mouvement-{{ evolution.type_mouvement }}">
                                {% if evolution.type_mouvement == 'entree' %}‚¨ÜÔ∏è Entr√©es
                                {% else %}‚¨áÔ∏è Sorties{% endif %}
                            </span>
                        </td>
                        <td>{{ evolution.quantite_totale|floatformat:1 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">Aucune donn√©e d'√©volution quotidienne.</div>
        {% endif %}
    </div>
    
    <div class="section">
        <h3>‚öôÔ∏è Configuration des Seuils</h3>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <p><strong>Seuils d'alerte actuels :</strong></p>
            <ul>
                <li><span style="color: #dc3545; font-weight: bold;">Stock critique :</span> ‚â§ {{ seuil_critique }} unit√©s</li>
                <li><span style="color: #ffc107; font-weight: bold;">Stock bas :</span> ‚â§ {{ seuil_bas }} unit√©s</li>
                <li><span style="color: #28a745; font-weight: bold;">Stock normal :</span> > {{ seuil_bas }} unit√©s</li>
            </ul>
            <p style="margin-top: 15px; color: #666; font-style: italic;">
                Ces seuils peuvent √™tre configur√©s dans les param√®tres du syst√®me.
            </p>
        </div>
    </div>
</div>
{% endblock %}