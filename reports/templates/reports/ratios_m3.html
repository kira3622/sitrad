{% extends "admin/base_site.html" %}

{% block title %}Ratios Matières par m³{% endblock %}

{% block content %}
<div class="content" style="margin: 20px;">
  <h1>Ratios Matières par m³</h1>
  {% include 'reports/_quick_access.html' %}

  <form method="get" class="filters" style="margin: 16px 0; display: flex; gap: 12px; align-items: center;">
    <label>
      Date début:
      <input type="date" name="date_debut" value="{{ date_debut }}" />
    </label>
    <label>
      Date fin:
      <input type="date" name="date_fin" value="{{ date_fin }}" />
    </label>
    <button type="submit" class="button" style="padding: 6px 12px;">Mettre à jour</button>
  </form>

  <section style="margin-top: 24px;">
    <h2>Consommation réelle par m³ (période)</h2>
    <p>Période: {{ date_debut }} → {{ date_fin }} | Total produit: <strong>{{ total_m3_produits|floatformat:2 }} m³</strong></p>

    <table class="listing" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Matière</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Unité</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">Sorties totales</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">Consommation / m³</th>
        </tr>
      </thead>
      <tbody>
        {% if total_m3_produits and total_m3_produits > 0 %}
          {% for item in ratios_reels %}
          <tr>
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ item.matiere }}</td>
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ item.unite }}</td>
            <td style="text-align:right; padding:8px; border-bottom:1px solid #f0f0f0;">{{ item.total_sorties|floatformat:2 }}</td>
            <td style="text-align:right; padding:8px; border-bottom:1px solid #f0f0f0;">{{ item.ratio_par_m3|floatformat:3 }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" style="padding:12px; text-align:center; color:#777;">Aucune production sur la période sélectionnée.</td>
          </tr>
        {% endif %}
      </tbody>
      <tfoot>
        <tr>
          <th style="text-align:left; padding:8px; border-top:1px solid #ddd;" colspan="2">TOTAL sorties (période)</th>
          <th style="text-align:right; padding:8px; border-top:1px solid #ddd;">{{ total_sorties_global|floatformat:2 }}</th>
          <th style="text-align:right; padding:8px; border-top:1px solid #ddd;">{{ consommation_moyenne_par_m3|floatformat:3 }}</th>
        </tr>
      </tfoot>
    </table>
  </section>

  <section style="margin-top: 32px;">
    <h2>Théorique par Matière</h2>
    <table class="listing" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Matière Première</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Formule</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">Ratio Théorique / m³</th>
        </tr>
      </thead>
      <tbody>
        {% for matiere_data in matieres_theorique_data %}
          {% for usage in matiere_data.formules_usage %}
          <tr>
            {% if forloop.first %}
              <td rowspan="{{ matiere_data.formules_usage|length }}" style="padding:8px; border-bottom:1px solid #f0f0f0; vertical-align: top;">
                {{ matiere_data.matiere_nom }} ({{ matiere_data.unite }})
              </td>
            {% endif %}
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ usage.formule_nom }}</td>
            <td style="text-align:right; padding:8px; border-bottom:1px solid #f0f0f0;">{{ usage.ratio|floatformat:3 }}</td>
          </tr>
          {% endfor %}
        {% empty %}
          <tr>
            <td colspan="3" style="padding:12px; text-align:center; color:#777;">Aucune donnée théorique disponible.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>
{% endblock %}